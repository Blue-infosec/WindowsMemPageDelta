Windows Executable Memory Page Delta Reporter
======================

A Windows Service to performantly produce telemetry on new or modified Windows memory pages that are now executable every 30 seconds.

Released as open source by NCC Group Plc - http://www.nccgroup.com/

Developed by Ollie Whitehouse, ollie dot whitehouse at nccgroup dot com

https://github.com/nccgroup/WindowsMemPageDelta

Released under AGPL see LICENSE for more information

Hypothesis
-------------
Collect enough telemetry from a Windows host/estate about which processes create and change memory as/to executeable along with their size and you'll be able to spot the anonamlies. These anomalies may be malicious activity.

Compatability
-------------
Only Windows 10 is supported / tested

What it does
-------------
Simply:
* rapidly scans Windows processes every 30 seconds
* enumerates their memory pages, protection and state
* identifies differences - noting those that are now executable that were not on the previous run

Performant in that
* consumes a constant of about 95MB of RAM
* takes about 8 seconds to run

To do
-------------
- [X] Add eventlog output
- [X] Make a Windows service

Command Line Options
-------------

Run it as a console app
```
WindowsMemPageDelta.exe -c
```

Run it as a Windows service
```
WindowsMemPageDelta.exe -s
```

Installation
-------------
```
REM -------------------------------------------
REM This is the installation
REM -------------------------------------------
REM Copy the Eventlog DLL to the Windows directory
copy NCCGroup-WMPD-EvtLog.dll c:\Windows\NCCGroup-WMPD-EvtLog.dll
REM Copy the Main Binary
copy WindowsMemPageDelta.exe c:\Windows\WindowsMemPageDelta.exe
REM Create the service
sc create NCCMemDelta displayname= "NCC Group Memory Delta" binpath= "\"c:\Windows\WindowsMemPageDelta.exe\" -s"
REM Start the service
net start NCCMemDelta

REM -------------------------------------------
REM This is the Eventlog manifest
REM -------------------------------------------
wevtutil install-manifest SvcEventManifest.man
```

Logs are in Event Logging
-------------
![Eventvwr Example](https://raw.githubusercontent.com/nccgroup/WindowsMemPageDelta/master/images/Eventvwr.PNG)

Output schema
-------------
The schema for new events is:
```
TYPE,PID,Process Name,Address,Size,Protection
```

Example
```
New,32068,ServiceHub.DataWarehouseHost.exe,7ffd5b9d0000,53248,XRW....
New,32068,ServiceHub.DataWarehouseHost.exe,7ffd93f51000,69632,XR....
New,32068,ServiceHub.DataWarehouseHost.exe,7ffd97241000,1015808,XR....
New,12692,ScriptedSandbox64.exe,1e247250000,20480,X.....
New,12692,ScriptedSandbox64.exe,1e2475f0000,4096,X.....
New,12692,ScriptedSandbox64.exe,1e247770000,32768,X.....
New,12692,ScriptedSandbox64.exe,1e2477b0000,12288,X.....
New,12692,ScriptedSandbox64.exe,1e2477f0000,16384,X.....
New,12692,ScriptedSandbox64.exe,1e247af0000,40960,X.....
...
```

The schema for change events is:

```
TYPE,PID,Process Name,Address,Size,Protection,Previous Protection
```

```
Changed,16008,Teams.exe,cc86df04000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc86e004000,86016,XR....,.RW....
Changed,16008,Teams.exe,cc86e084000,86016,XR....,.RW....
Changed,16008,Teams.exe,cc86e104000,86016,XR....,.RW....
Changed,16008,Teams.exe,cc86e284000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc86e604000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc86e984000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc86ea04000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc86ec84000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc86ee04000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc86ef04000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc86f104000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc86f284000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc86f784000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc86f904000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc86f984000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc86fb84000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc86fc04000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc871304000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc871c04000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc871d04000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc872184000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc872684000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc872884000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc872b84000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc872c04000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc872c84000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc872d04000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc872d84000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc872f04000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc873584000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc874004000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc874304000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc875284000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc875704000,503808,XR....,.RW....
Changed,16008,Teams.exe,cc875884000,503808,XR....,.RW....
```
